name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

# Only allow one CI run per PR at a time
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  # Required for security scanning result uploads
  security-events: write
  # Required for coverage reporting
  checks: write

jobs:
  # Format check - validates Go formatting
  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff  # v5
        with:
          go-version: '1.26'
          cache: true
          cache-dependency-path: go.sum

      - name: Check formatting with gofmt
        run: |
          # Get list of Go files that differ from gofmt
          UNFORMATTED=$(gofmt -l . | grep -v vendor | grep -v web || true)
          if [ -n "$UNFORMATTED" ]; then
            echo "The following files are not formatted correctly:"
            echo "$UNFORMATTED"
            echo "Run 'gofmt -w .' to fix"
            exit 1
          fi
          echo "All files properly formatted"

  # Vet - runs go vet static analysis
  vet:
    name: Vet
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff  # v5
        with:
          go-version: '1.26'
          cache: true
          cache-dependency-path: go.sum

      - name: Run go vet
        run: go vet ./...

  # Lint - runs golangci-lint with configured linters
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff  # v5
        with:
          go-version: '1.26'
          cache: true
          cache-dependency-path: go.sum

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@55c2c1448f86e01eaae002a5a3a9624417608d84  # v6
        with:
          version: v2.1
          # Only report issues on new code in PRs
          only-new-issues: ${{ github.event_name == 'pull_request' }}
          # Use config from repo
          args: --config=.golangci.yml --timeout=10m
          # Disable caching to ensure fresh results
          skip-cache: false

  # Security - runs govulncheck for known vulnerabilities
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff  # v5
        with:
          go-version: '1.26'
          cache: true
          cache-dependency-path: go.sum

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

  # Test - runs unit tests with coverage
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff  # v5
        with:
          go-version: '1.26'
          cache: true
          cache-dependency-path: go.sum

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run tests with coverage
        run: |
          mkdir -p test/cover
          go test -v -race -timeout 5m \
            -covermode=atomic \
            -coverprofile=test/cover/coverage.out \
            -coverpkg=./internal/... ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de  # v5
        with:
          file: ./test/cover/coverage.out
          flags: unittests
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
          verbose: true

  # Integration tests
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 0  # Needed for git history in integration tests

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff  # v5
        with:
          go-version: '1.26'
          cache: true
          cache-dependency-path: go.sum

      - name: Run integration tests
        run: go test -v -race -tags=integration -timeout 5m ./test/integration/...

  # E2E tests
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 0  # Needed for git history in e2e tests

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff  # v5
        with:
          go-version: '1.26'
          cache: true
          cache-dependency-path: go.sum

      - name: Run e2e tests
        run: go test -v -race -tags=e2e -timeout 5m ./test/e2e/...

  # Validate JavaScript
  validate-js:
    name: Validate JavaScript
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4
        with:
          node-version: '20'

      - name: Validate JavaScript syntax
        run: |
          echo "Validating JavaScript syntax..."
          find web -name '*.js' -print0 | while IFS= read -r -d '' file; do
            echo "Checking $file..."
            if ! node --check "$file"; then
              echo "Syntax error in $file"
              exit 1
            fi
          done
          echo "All JavaScript files valid"

      - name: Check for ES module syntax
        run: |
          echo "Checking for CommonJS in ES modules..."
          if grep -rn "module.exports\|require(" web/ --include='*.js' | grep -v "// @allow-commonjs"; then
            echo "Found CommonJS syntax in ES modules - use // @allow-commonjs if intentional"
            exit 1
          fi
          echo "JavaScript module syntax validated"

  # Build - builds both binaries
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff  # v5
        with:
          go-version: '1.26'
          cache: true
          cache-dependency-path: go.sum

      - name: Build main binary
        run: go build -v -o gitvista ./cmd/vista

      - name: Build CLI binary
        run: go build -v -o gitvista-cli ./cmd/gitcli

      - name: Verify binaries
        run: |
          echo "Checking main binary..."
          file gitvista
          ./gitvista -h || ./gitvista --help || echo "Binary built successfully"
          echo "Checking CLI binary..."
          file gitvista-cli

  # Docker build - verifies Docker image builds without errors
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # v3

      - name: Build Docker image
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8  # v6
        with:
          context: .
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: gitvista:test

  # Dependency check - ensures no vulnerable dependencies
  dependencies:
    name: Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff  # v5
        with:
          go-version: '1.26'
          cache: true
          cache-dependency-path: go.sum

      - name: Check for outdated dependencies
        run: |
          echo "Checking Go module dependencies..."
          go mod tidy -diff || (echo "Run 'go mod tidy' to update dependencies"; exit 1)
          go mod download
          go mod verify

  # Status check - a final job that requires all other jobs to pass
  # Use this in branch protection rules as the required check
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    if: always()
    needs: [format, vet, lint, security, test, integration, e2e, validate-js, build, docker-build, dependencies]
    steps:
      - name: Check CI status
        run: |
          if [ "${{ needs.format.result }}" != "success" ]; then
            echo "Format check failed"
            exit 1
          fi
          if [ "${{ needs.vet.result }}" != "success" ]; then
            echo "Vet check failed"
            exit 1
          fi
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "Lint check failed"
            exit 1
          fi
          if [ "${{ needs.security.result }}" != "success" ]; then
            echo "Security check failed"
            exit 1
          fi
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "Test check failed"
            exit 1
          fi
          if [ "${{ needs.integration.result }}" != "success" ]; then
            echo "Integration test check failed"
            exit 1
          fi
          if [ "${{ needs.e2e.result }}" != "success" ]; then
            echo "E2E test check failed"
            exit 1
          fi
          if [ "${{ needs.validate-js.result }}" != "success" ]; then
            echo "JavaScript validation failed"
            exit 1
          fi
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "Build check failed"
            exit 1
          fi
          if [ "${{ needs.docker-build.result }}" != "success" ]; then
            echo "Docker build check failed"
            exit 1
          fi
          if [ "${{ needs.dependencies.result }}" != "success" ]; then
            echo "Dependency check failed"
            exit 1
          fi
          echo "All CI checks passed!"
